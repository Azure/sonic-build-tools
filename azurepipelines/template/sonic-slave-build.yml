parameters:
- name: arch
  values:
  - amd64
  - armhf
  - arm64
- name: distro
  values:
  - buster
  - jessie
  - stretch

steps:
  - bash: |
      set -ex
      docker --version
      echo "Build docker container for ${{ parameters.distro }} and ${{ arch }}"

      USER=`id -un | tr A-Z a-z`
      SLAVE_DIR=sonic-slave-${{ parameters.distro }}
      if [ x$arch == x"amd64" ]; then
        SLAVE_BASE_IMAGE=${SLAVE_DIR}
      else
        SLAVE_BASE_IMAGE=${SLAVE_DIR}-${{ arch }}
      fi

      tmpfile=$(mktemp)

      echo ${{ arch }} > .arch

      DOCKER_DATA_ROOT_FOR_MULTIARCH=/data/march/docker BLDENV=${{ parameters.distro }} make -f Makefile.work sonic-slave-build | tee $tmpfile
      SLAVE_BASE_TAG=$(grep "^Checking sonic-slave-base image:" $tmpfile | awk -F ':' '{print $3}')
      SLAVE_TAG=$(grep "^Checking sonic-slave image:" $tmpfile | awk -F ':' '{print $3}')

      echo $USER
      echo $SLAVE_BASE_TAG
      echo $SLAVE_TAG
      mkdir -p target
      docker images
      docker save $SLAVE_BASE_IMAGE-$USER:$SLAVE_TAG | gzip -c > target/$SLAVE_BASE_IMAGE.gz
      docker tag $SLAVE_BASE_IMAGE-$USER:$SLAVE_TAG local/$SLAVE_BASE_IMAGE-$USER:latest
      docker tag $SLAVE_BASE_IMAGE-$USER:$SLAVE_TAG $REGISTRY_SERVER:$REGISTRY_PORT/$SLAVE_BASE_IMAGE-$USER:latest
      docker tag $SLAVE_BASE_IMAGE:$SLAVE_BASE_TAG $REGISTRY_SERVER:$REGISTRY_PORT/$SLAVE_BASE_IMAGE:latest
      docker tag $SLAVE_BASE_IMAGE:$SLAVE_BASE_TAG $REGISTRY_SERVER:$REGISTRY_PORT/$SLAVE_BASE_IMAGE:$SLAVE_BASE_TAG
      
      echo "##vso[task.setvariable variable=SLAVE_BASE_IMAGE]$SLAVE_BASE_IMAGE"
      echo "##vso[task.setvariable variable=USER]$USER"
      echo "##vso[task.setvariable variable=SLAVE_BASE_TAG]$SLAVE_BASE_TAG"
    env:
      REGISTRY_SERVER: soniccr2.azurecr.io
      REGISTRY_PORT: 443
    displayName: build sonic-slave-${{ parameters.distro }}
  - task: Docker@2
    inputs:
      containerRegistry: 'soniccr2'
      command: 'push'
      tags: |
        $(SLAVE_BASE_IMAGE)-$(USER):latest
        $(SLAVE_BASE_IMAGE):latest
        $(SLAVE_BASE_IMAGE):$(SLAVE_BASE_TAG)